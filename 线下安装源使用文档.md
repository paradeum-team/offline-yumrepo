#k8s线下源使用文档

###解压   
`tar -zxvf offline-k8s-install-package.tar.gz`       
解压完成后，目录下有以下几个目录    

- offline-k8s  
- offline-registry       
- offline-registry-image 
- offline-registry_data  
- offline-yumrepo 
- offline-k8s-otherfile  

### 替换ip
1.进入offline-k8s目录  
`cd  offline-k8s`   

2.修改config.cfg文件中的ip和端口号  
LOCAL_IP 和 CONFIGSERVER_IP 均为本机内网ip，若无内外网之ip，则填本机ip，默认127.0.0.1。   
CONFIGSERVER_PORT 为本机未被占用的端口号，默认8001。   
linux 查看已用端口命令  
`netstat -tulnp`  


### 启动线下yumrepo源   
1.进入目录offline-yumrepo   
`cd ..`  
`cd offline-yumrepo`     
2.启动
`sudo ./enable.sh`   
3.使用线下yumrepo  
按照当前目录下的yum_repo_readme.txt文档首先安装repo命令     
eg:`curl -Ls http://ip:port/packages/centos/get_repo.sh|bash -s ip:port base`    
其余的yum安装包需根据自己需求安装    

### 启动线下registry源   
1.启动线下registry源需要先安装docker，利用线下yumrepo源安装      

```
sudo yum --disablerepo=\* --enablerepo=offline-k8s* install -y yum-utils device-mapper-persistent-data lvm2 
sudo yum --disablerepo=\* --enablerepo=offline-k8s* install -y  containerd.io-1.2.13 docker-ce-19.03.11 docker-ce-cli-19.03.11
       
``` 

2.设置docker daemon     
`sudo mkdir /etc/docker`  
`cat <<EOF | sudo tee /etc/docker/daemon.json
{
  "insecure-registries":["offlineregistry.offline-k8s.com:5000"]
}
EOF`

3.设置域名解析   
`ip offlineregistry.offline-k8s.com`  
4. 启动docker  

```
#Create /etc/systemd/system/docker.service.d
sudo mkdir -p /etc/systemd/system/docker.service.d    
sudo systemctl daemon-reload
sudo systemctl restart docker  

# 设置开机启动  
sudo systemctl enable docker --now  
```

4.进入目录offline-registry   
`cd offline-registry`  
5.启动线下registry源   
`sudo ./enable.sh`      





###k8s 手动线下安装
 一部分命令，具体安装参照[安装流程](https://github.com/paradeum-team/operator-env/blob/main/centos7-k8s/CentOS7.9-%E5%AE%89%E8%A3%85k8s-1.20.0.md)   
 
```
cat <<EOF | sudo tee /etc/docker/daemon.json
{
  "insecure-registries":["offlineregistry.offline-k8s.com:5000"],
  "exec-opts": ["native.cgroupdriver=systemd"],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "100m"
  },
  "storage-driver": "overlay2",
  "storage-opts": [
    "overlay2.override_kernel_check=true"
  ],
  "registry-mirrors": [
    "https://offlineregistry.offline-k8s.com:5000"
  ]
}
EOF 

```   
  
`yum --disablerepo=\* --enablerepo=offline-k8s* install -y kubelet kubeadm kubectl`   
 
  

```
cat >/etc/sysconfig/kubelet<<EOF
KUBELET_EXTRA_ARGS="--pod-infra-container-image=offlineregistry.offline-k8s.com:5000/google_containers/pause:3.2"
EOF
```  
```
cat <<EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf
net.bridge.bridge-nf-call-iptables  = 1
net.ipv4.ip_forward                 = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF

```  
`yum --disablerepo=\* --enablerepo=offline-k8s* install -y bash-completion`

`kubeadm init --kubernetes-version=v--image-repository offlineregistry.offline-k8s.com:5000/google_containers --pod-network-cidr=10.128.0.0/16`


kubeadm join 172.26.117.85:6443 --token k1ikp8.97stdko0e55hei36 \
    --discovery-token-ca-cert-hash sha256:bd7aca7739a2b5268d84c66352ba1bba7169b047062ed6c09fda828a3b133715
 
sed -i "s/jack/tom/g" test.txt




